<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wan2.1视频生成平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; }
        .btn-primary { @apply px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600; }
        .btn-secondary { @apply px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300; }
        .progress-bar { width: 100%; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-bar-value { height: 100%; background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <h1 class="text-3xl font-bold mb-8 text-center">Wan2.1 视频生成平台</h1>

    <div class="flex mb-4 border-b">
        <button id="tab-form" class="px-4 py-2 border-b-2 border-blue-500 font-medium">创建任务</button>
        <button id="tab-tasks" class="px-4 py-2">任务列表</button>
    </div>

    <div id="form-panel" class="bg-white p-6 rounded-lg shadow-md">
        <form id="generation-form">
            <div class="mb-4">
                <label class="block mb-2 font-medium">任务类型</label>
                <div class="flex">
                    <button type="button" id="btn-t2v" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-l">文本生成视频</button>
                    <button type="button" id="btn-i2v" class="flex-1 px-4 py-2 bg-gray-200 rounded-r">图像生成视频</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block mb-2 font-medium">提示词 <span class="text-red-500">*</span></label>
                <textarea id="prompt" class="w-full p-2 border rounded" rows="4" required></textarea>
            </div>

            <div class="mb-4">
                <label class="block mb-2 font-medium">负面提示词</label>
                <textarea id="negative-prompt" class="w-full p-2 border rounded" rows="2">色调艳丽，过曝，静态，细节模糊不清，字幕，风格，作品，画作，画面，静止，整体发灰，最差质量，低质量，JPEG压缩残留，丑陋的，残缺的，多余的手指，画得不好的手部，画得不好的脸部，畸形的，毁容的，形态畸形的肢体，手指融合，静止不动的画面，杂乱的背景，三条腿，背景人很多，倒着走</textarea>
            </div>

            <div id="image-upload-container" class="mb-4 hidden">
                <label class="block mb-2 font-medium">上传图片 <span class="text-red-500">*</span></label>
                <div class="border-2 border-dashed border-gray-300 p-4 text-center rounded">
                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                    <div id="image-preview-container" class="hidden mb-2"></div>
                    <button type="button" id="btn-upload" class="px-4 py-2 bg-gray-200 rounded">选择图片</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 font-medium">分辨率</label>
                    <select id="resolution" class="w-full p-2 border rounded">
                        <option value="832x480">480P (832x480)</option>
                        <option value="480x832">480P 竖屏 (480x832)</option>
                        <option value="1280x720">720P (1280x720)</option>
                        <option value="720x1280">720P 竖屏 (720x1280)</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 font-medium">帧数</label>
                    <input type="number" id="num-frames" class="w-full p-2 border rounded" value="100" min="5" max="200">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 font-medium">帧率</label>
                    <input type="number" id="fps" class="w-full p-2 border rounded" value="20" min="5" max="60">
                </div>
                <div>
                    <label class="block mb-2 font-medium">推理步数</label>
                    <input type="number" id="steps" class="w-full p-2 border rounded" value="40" min="20" max="60">
                </div>
            </div>

            <div class="mb-4">
                <button type="button" id="toggle-advanced" class="text-blue-500 underline">显示高级参数</button>
            </div>

            <div id="advanced-params" class="hidden p-4 bg-gray-50 border rounded mb-4">
                <h3 class="font-medium mb-3">高级参数</h3>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="fp8" checked class="mr-2">
                            <span>使用FP8精度</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="save-vram" class="mr-2">
                            <span>节省显存模式</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block mb-2 font-medium">种子</label>
                        <div class="flex">
                            <input type="number" id="seed" class="w-full p-2 border rounded-l" placeholder="随机">
                            <button type="button" id="btn-random-seed" class="px-2 bg-gray-200 rounded-r">🎲</button>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">引导比例</label>
                        <input type="number" id="guidance-scale" class="w-full p-2 border rounded" value="5.0" min="1" max="10" step="0.1">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">采样偏移</label>
                        <input type="number" id="sample-shift" class="w-full p-2 border rounded" value="5.0" min="1" max="10" step="0.1">
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <button type="submit" id="btn-submit" class="w-full py-3 bg-blue-500 text-white rounded text-lg font-medium hover:bg-blue-600">开始生成</button>
            </div>
        </form>
    </div>

    <div id="tasks-panel" class="bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-medium">任务列表</h2>
            <button id="btn-refresh" class="text-blue-500">刷新</button>
        </div>

        <div id="tasks-container">
            <p class="text-center py-8 text-gray-500">加载中...</p>
        </div>
    </div>

    <div id="log-panel" class="mt-8 p-4 bg-gray-100 rounded-lg">
        <h3 class="font-bold mb-2">调试日志</h3>
        <div id="api-log" class="bg-black text-green-400 p-2 rounded h-40 overflow-auto font-mono text-sm"></div>
    </div>
</div>

<div id="video-preview" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-xl font-semibold">视频预览</h3>
            <button id="close-preview" class="text-gray-500 hover:text-gray-700">×</button>
        </div>
        <div class="p-4">
            <video id="preview-video" controls class="max-w-full max-h-[70vh]"></video>
        </div>
    </div>
</div>

<script>
    // 简单版前端JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        const API_URL = window.location.protocol + '//' + window.location.hostname + ':8000';
        console.log('API地址:', API_URL);

        function log(message) {
            const logEl = document.getElementById('api-log');
            const timestamp = new Date().toISOString();
            logEl.innerHTML = `[${timestamp}] ${message}\n` + logEl.innerHTML;
        }

        log(`初始化应用，API地址: ${API_URL}`);

        const taskType = { current: 't2v' };
        const tabForm = document.getElementById('tab-form');
        const tabTasks = document.getElementById('tab-tasks');
        const formPanel = document.getElementById('form-panel');
        const tasksPanel = document.getElementById('tasks-panel');
        const btnT2V = document.getElementById('btn-t2v');
        const btnI2V = document.getElementById('btn-i2v');
        const imageUploadContainer = document.getElementById('image-upload-container');
        const imageUpload = document.getElementById('image-upload');
        const btnUpload = document.getElementById('btn-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const toggleAdvanced = document.getElementById('toggle-advanced');
        const advancedParams = document.getElementById('advanced-params');
        const btnRandomSeed = document.getElementById('btn-random-seed');
        const btnSubmit = document.getElementById('btn-submit');
        const btnRefresh = document.getElementById('btn-refresh');
        const form = document.getElementById('generation-form');

        // 切换标签
        tabForm.addEventListener('click', () => {
            tabForm.classList.add('border-b-2', 'border-blue-500', 'font-medium');
            tabTasks.classList.remove('border-b-2', 'border-blue-500', 'font-medium');
            formPanel.classList.remove('hidden');
            tasksPanel.classList.add('hidden');
        });

        tabTasks.addEventListener('click', () => {
            tabTasks.classList.add('border-b-2', 'border-blue-500', 'font-medium');
            tabForm.classList.remove('border-b-2', 'border-blue-500', 'font-medium');
            tasksPanel.classList.remove('hidden');
            formPanel.classList.add('hidden');
            fetchTasks();
        });

        // 切换任务类型
        btnT2V.addEventListener('click', () => {
            taskType.current = 't2v';
            btnT2V.classList.add('bg-blue-500', 'text-white');
            btnT2V.classList.remove('bg-gray-200', 'text-gray-700');
            btnI2V.classList.add('bg-gray-200', 'text-gray-700');
            btnI2V.classList.remove('bg-blue-500', 'text-white');
            imageUploadContainer.classList.add('hidden');
        });

        btnI2V.addEventListener('click', () => {
            taskType.current = 'i2v';
            btnI2V.classList.add('bg-blue-500', 'text-white');
            btnI2V.classList.remove('bg-gray-200', 'text-gray-700');
            btnT2V.classList.add('bg-gray-200', 'text-gray-700');
            btnT2V.classList.remove('bg-blue-500', 'text-white');
            imageUploadContainer.classList.remove('hidden');
        });

        // 图片上传
        btnUpload.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreviewContainer.innerHTML = `<img src="${e.target.result}" class="max-h-40 mx-auto" />`;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // 高级参数
        toggleAdvanced.addEventListener('click', () => {
            advancedParams.classList.toggle('hidden');
            toggleAdvanced.textContent = advancedParams.classList.contains('hidden') ? '显示高级参数' : '隐藏高级参数';
        });

        // 随机种子
        btnRandomSeed.addEventListener('click', () => {
            document.getElementById('seed').value = Math.floor(Math.random() * 1000000);
        });

        // 提交表单
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const prompt = document.getElementById('prompt').value;
            if (!prompt) {
                alert('请输入提示词');
                return;
            }

            if (taskType.current === 'i2v' && !imageUpload.files.length) {
                alert('请上传图片');
                return;
            }

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="inline-block animate-spin mr-2">⟳</span> 提交中...';

            const formData = new FormData();
            formData.append('task_type', taskType.current);
            formData.append('prompt', prompt);
            formData.append('negative_prompt', document.getElementById('negative-prompt').value);
            formData.append('resolution', document.getElementById('resolution').value);
            formData.append('num_frames', document.getElementById('num-frames').value);
            formData.append('fps', document.getElementById('fps').value);
            formData.append('num_inference_steps', document.getElementById('steps').value);
            formData.append('fp8', document.getElementById('fp8').checked);
            formData.append('save_vram', document.getElementById('save-vram').checked);

            const seed = document.getElementById('seed').value;
            if (seed) {
                formData.append('seed', seed);
            }

            formData.append('guidance_scale', document.getElementById('guidance-scale').value);
            formData.append('sample_shift', document.getElementById('sample-shift').value);

            if (taskType.current === 'i2v' && imageUpload.files.length) {
                formData.append('image', imageUpload.files[0]);
            }

            log(`提交任务: ${API_URL}/api/generate`);

            try {
                const response = await fetch(`${API_URL}/api/generate`, {
                    method: 'POST',
                    body: formData
                });

                log(`API响应: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    let errorText = '';
                    try {
                        const error = await response.json();
                        errorText = error.detail || '';
                    } catch(e) {
                        errorText = await response.text() || '';
                    }
                    throw new Error(`${response.status} ${response.statusText} ${errorText}`);
                }

                const data = await response.json();
                log(`任务提交成功: ${JSON.stringify(data)}`);

                alert('任务已提交，ID: ' + data.task_id);

                // 清空表单
                if (taskType.current === 'i2v') {
                    imageUpload.value = '';
                    imagePreviewContainer.classList.add('hidden');
                    imagePreviewContainer.innerHTML = '';
                }

                // 切换到任务列表
                tabTasks.click();

            } catch (error) {
                log(`错误: ${error.message}`);
                alert('错误: ' + error.message);
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.textContent = '开始生成';
            }
        });

        // 获取任务列表
        async function fetchTasks() {
            const tasksContainer = document.getElementById('tasks-container');
            tasksContainer.innerHTML = '<p class="text-center py-8 text-gray-500">加载中...</p>';

            log(`获取任务列表: ${API_URL}/api/tasks`);

            try {
                const response = await fetch(`${API_URL}/api/tasks`);
                log(`任务列表响应: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    throw new Error(`${response.status} ${response.statusText}`);
                }

                const tasks = await response.json();
                log(`获取到 ${tasks.length} 个任务`);

                if (tasks.length === 0) {
                    tasksContainer.innerHTML = '<p class="text-center py-8 text-gray-500">暂无任务</p>';
                    return;
                }

                tasksContainer.innerHTML = '';

                tasks.forEach(task => {
                    const statusClass = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'processing': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'failed': 'bg-red-100 text-red-800',
                        'cancelled': 'bg-gray-100 text-gray-800'
                    }[task.status] || 'bg-gray-100 text-gray-800';

                    const statusText = {
                        'pending': '等待中',
                        'processing': '处理中',
                        'completed': '已完成',
                        'failed': '失败',
                        'cancelled': '已取消'
                    }[task.status] || task.status;

                    const taskTypeText = task.task_type === 't2v' ? '文本生成视频' : '图像生成视频';

                    let progressHtml = '';
                    if (task.status === 'processing') {
                        const percentage = Math.round((task.progress || 0) * 100);
                        progressHtml = `
                <div class="mb-2">
                  <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span>${task.message || '处理中...'}</span>
                    <span>${percentage}%</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-bar-value" style="width: ${percentage}%"></div>
                  </div>
                </div>
              `;
                    }

                    let actionButtons = '';
                    if (['pending', 'processing'].includes(task.status)) {
                        actionButtons = `<button class="text-red-500 text-sm btn-cancel" data-id="${task.task_id}">取消</button>`;
                    } else if (task.status === 'completed' && task.output_path) {
                        const videoUrl = task.output_path.startsWith('http') ? task.output_path : `${API_URL}${task.output_path}`;
                        actionButtons = `
                <button class="text-blue-500 text-sm btn-preview mr-2" data-url="${videoUrl}">预览</button>
                <a href="${videoUrl}" target="_blank" class="text-green-500 text-sm">下载</a>
              `;
                    }

                    const taskEl = document.createElement('div');
                    taskEl.className = 'border rounded p-4 mb-4';
                    taskEl.innerHTML = `
              <div class="flex justify-between mb-2">
                <span class="font-medium">${taskTypeText}</span>
                <span class="px-2 py-1 rounded text-xs ${statusClass}">${statusText}</span>
              </div>
              <p class="text-sm text-gray-600 mb-2 truncate">${task.prompt}</p>
              ${progressHtml}
              <div class="flex justify-between items-center">
                <div class="text-xs text-gray-500">
                  分辨率: ${task.resolution} | 帧数: ${task.num_frames}
                </div>
                <div>${actionButtons}</div>
              </div>
            `;

                    tasksContainer.appendChild(taskEl);
                });

                // 绑定取消按钮事件
                document.querySelectorAll('.btn-cancel').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const taskId = btn.getAttribute('data-id');
                        if (confirm('确定要取消此任务吗？')) {
                            log(`取消任务: ${taskId}`);
                            try {
                                const response = await fetch(`${API_URL}/api/tasks/${taskId}/cancel`, {
                                    method: 'POST'
                                });

                                log(`取消任务响应: ${response.status} ${response.statusText}`);

                                if (response.ok) {
                                    alert('任务已取消');
                                    fetchTasks();
                                } else {
                                    alert('取消任务失败');
                                }
                            } catch (error) {
                                log(`取消任务错误: ${error.message}`);
                                alert('错误: ' + error.message);
                            }
                        }
                    });
                });

                // 绑定预览按钮事件
                document.querySelectorAll('.btn-preview').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const videoUrl = btn.getAttribute('data-url');
                        log(`预览视频: ${videoUrl}`);

                        const previewEl = document.getElementById('video-preview');
                        const videoEl = document.getElementById('preview-video');

                        videoEl.src = videoUrl;
                        previewEl.classList.remove('hidden');

                        // 加载错误处理
                        videoEl.onerror = () => {
                            log(`视频加载失败: ${videoUrl}`);
                            alert('视频加载失败，可能还未生成完成或地址错误');
                        };
                    });
                });

            } catch (error) {
                log(`获取任务列表错误: ${error.message}`);
                tasksContainer.innerHTML = `<p class="text-center py-8 text-red-500">加载失败: ${error.message}</p>`;
            }
        }

        // 关闭预览
        document.getElementById('close-preview').addEventListener('click', () => {
            const previewEl = document.getElementById('video-preview');
            const videoEl = document.getElementById('preview-video');

            videoEl.pause();
            videoEl.src = '';
            previewEl.classList.add('hidden');
        });

        // 刷新任务列表
        btnRefresh.addEventListener('click', fetchTasks);

        // 初始加载
        log('初始加载任务');
        fetchTasks();
    });
</script>
</body>
</html>