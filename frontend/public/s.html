<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wan2.1è§†é¢‘ç”Ÿæˆå¹³å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; }
        .btn-primary { @apply px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600; }
        .btn-secondary { @apply px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300; }
        .progress-bar { width: 100%; height: 8px; background-color: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-bar-value { height: 100%; background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50">
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <h1 class="text-3xl font-bold mb-8 text-center">Wan2.1 è§†é¢‘ç”Ÿæˆå¹³å°</h1>

    <div class="flex mb-4 border-b">
        <button id="tab-form" class="px-4 py-2 border-b-2 border-blue-500 font-medium">åˆ›å»ºä»»åŠ¡</button>
        <button id="tab-tasks" class="px-4 py-2">ä»»åŠ¡åˆ—è¡¨</button>
    </div>

    <div id="form-panel" class="bg-white p-6 rounded-lg shadow-md">
        <form id="generation-form">
            <div class="mb-4">
                <label class="block mb-2 font-medium">ä»»åŠ¡ç±»å‹</label>
                <div class="flex">
                    <button type="button" id="btn-t2v" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-l">æ–‡æœ¬ç”Ÿæˆè§†é¢‘</button>
                    <button type="button" id="btn-i2v" class="flex-1 px-4 py-2 bg-gray-200 rounded-r">å›¾åƒç”Ÿæˆè§†é¢‘</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block mb-2 font-medium">æç¤ºè¯ <span class="text-red-500">*</span></label>
                <textarea id="prompt" class="w-full p-2 border rounded" rows="4" required></textarea>
            </div>

            <div class="mb-4">
                <label class="block mb-2 font-medium">è´Ÿé¢æç¤ºè¯</label>
                <textarea id="negative-prompt" class="w-full p-2 border rounded" rows="2">è‰²è°ƒè‰³ä¸½ï¼Œè¿‡æ›ï¼Œé™æ€ï¼Œç»†èŠ‚æ¨¡ç³Šä¸æ¸…ï¼Œå­—å¹•ï¼Œé£æ ¼ï¼Œä½œå“ï¼Œç”»ä½œï¼Œç”»é¢ï¼Œé™æ­¢ï¼Œæ•´ä½“å‘ç°ï¼Œæœ€å·®è´¨é‡ï¼Œä½è´¨é‡ï¼ŒJPEGå‹ç¼©æ®‹ç•™ï¼Œä¸‘é™‹çš„ï¼Œæ®‹ç¼ºçš„ï¼Œå¤šä½™çš„æ‰‹æŒ‡ï¼Œç”»å¾—ä¸å¥½çš„æ‰‹éƒ¨ï¼Œç”»å¾—ä¸å¥½çš„è„¸éƒ¨ï¼Œç•¸å½¢çš„ï¼Œæ¯å®¹çš„ï¼Œå½¢æ€ç•¸å½¢çš„è‚¢ä½“ï¼Œæ‰‹æŒ‡èåˆï¼Œé™æ­¢ä¸åŠ¨çš„ç”»é¢ï¼Œæ‚ä¹±çš„èƒŒæ™¯ï¼Œä¸‰æ¡è…¿ï¼ŒèƒŒæ™¯äººå¾ˆå¤šï¼Œå€’ç€èµ°</textarea>
            </div>

            <div id="image-upload-container" class="mb-4 hidden">
                <label class="block mb-2 font-medium">ä¸Šä¼ å›¾ç‰‡ <span class="text-red-500">*</span></label>
                <div class="border-2 border-dashed border-gray-300 p-4 text-center rounded">
                    <input type="file" id="image-upload" class="hidden" accept="image/*">
                    <div id="image-preview-container" class="hidden mb-2"></div>
                    <button type="button" id="btn-upload" class="px-4 py-2 bg-gray-200 rounded">é€‰æ‹©å›¾ç‰‡</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 font-medium">åˆ†è¾¨ç‡</label>
                    <select id="resolution" class="w-full p-2 border rounded">
                        <option value="832x480">480P (832x480)</option>
                        <option value="480x832">480P ç«–å± (480x832)</option>
                        <option value="1280x720">720P (1280x720)</option>
                        <option value="720x1280">720P ç«–å± (720x1280)</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 font-medium">å¸§æ•°</label>
                    <input type="number" id="num-frames" class="w-full p-2 border rounded" value="100" min="5" max="200">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block mb-2 font-medium">å¸§ç‡</label>
                    <input type="number" id="fps" class="w-full p-2 border rounded" value="20" min="5" max="60">
                </div>
                <div>
                    <label class="block mb-2 font-medium">æ¨ç†æ­¥æ•°</label>
                    <input type="number" id="steps" class="w-full p-2 border rounded" value="40" min="20" max="60">
                </div>
            </div>

            <div class="mb-4">
                <button type="button" id="toggle-advanced" class="text-blue-500 underline">æ˜¾ç¤ºé«˜çº§å‚æ•°</button>
            </div>

            <div id="advanced-params" class="hidden p-4 bg-gray-50 border rounded mb-4">
                <h3 class="font-medium mb-3">é«˜çº§å‚æ•°</h3>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="fp8" checked class="mr-2">
                            <span>ä½¿ç”¨FP8ç²¾åº¦</span>
                        </label>
                    </div>
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" id="save-vram" class="mr-2">
                            <span>èŠ‚çœæ˜¾å­˜æ¨¡å¼</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block mb-2 font-medium">ç§å­</label>
                        <div class="flex">
                            <input type="number" id="seed" class="w-full p-2 border rounded-l" placeholder="éšæœº">
                            <button type="button" id="btn-random-seed" class="px-2 bg-gray-200 rounded-r">ğŸ²</button>
                        </div>
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">å¼•å¯¼æ¯”ä¾‹</label>
                        <input type="number" id="guidance-scale" class="w-full p-2 border rounded" value="5.0" min="1" max="10" step="0.1">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">é‡‡æ ·åç§»</label>
                        <input type="number" id="sample-shift" class="w-full p-2 border rounded" value="5.0" min="1" max="10" step="0.1">
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <button type="submit" id="btn-submit" class="w-full py-3 bg-blue-500 text-white rounded text-lg font-medium hover:bg-blue-600">å¼€å§‹ç”Ÿæˆ</button>
            </div>
        </form>
    </div>

    <div id="tasks-panel" class="bg-white p-6 rounded-lg shadow-md hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-medium">ä»»åŠ¡åˆ—è¡¨</h2>
            <button id="btn-refresh" class="text-blue-500">åˆ·æ–°</button>
        </div>

        <div id="tasks-container">
            <p class="text-center py-8 text-gray-500">åŠ è½½ä¸­...</p>
        </div>
    </div>

    <div id="log-panel" class="mt-8 p-4 bg-gray-100 rounded-lg">
        <h3 class="font-bold mb-2">è°ƒè¯•æ—¥å¿—</h3>
        <div id="api-log" class="bg-black text-green-400 p-2 rounded h-40 overflow-auto font-mono text-sm"></div>
    </div>
</div>

<div id="video-preview" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-xl font-semibold">è§†é¢‘é¢„è§ˆ</h3>
            <button id="close-preview" class="text-gray-500 hover:text-gray-700">Ã—</button>
        </div>
        <div class="p-4">
            <video id="preview-video" controls class="max-w-full max-h-[70vh]"></video>
        </div>
    </div>
</div>

<script>
    // ç®€å•ç‰ˆå‰ç«¯JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        const API_URL = window.location.protocol + '//' + window.location.hostname + ':8000';
        console.log('APIåœ°å€:', API_URL);

        function log(message) {
            const logEl = document.getElementById('api-log');
            const timestamp = new Date().toISOString();
            logEl.innerHTML = `[${timestamp}] ${message}\n` + logEl.innerHTML;
        }

        log(`åˆå§‹åŒ–åº”ç”¨ï¼ŒAPIåœ°å€: ${API_URL}`);

        const taskType = { current: 't2v' };
        const tabForm = document.getElementById('tab-form');
        const tabTasks = document.getElementById('tab-tasks');
        const formPanel = document.getElementById('form-panel');
        const tasksPanel = document.getElementById('tasks-panel');
        const btnT2V = document.getElementById('btn-t2v');
        const btnI2V = document.getElementById('btn-i2v');
        const imageUploadContainer = document.getElementById('image-upload-container');
        const imageUpload = document.getElementById('image-upload');
        const btnUpload = document.getElementById('btn-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const toggleAdvanced = document.getElementById('toggle-advanced');
        const advancedParams = document.getElementById('advanced-params');
        const btnRandomSeed = document.getElementById('btn-random-seed');
        const btnSubmit = document.getElementById('btn-submit');
        const btnRefresh = document.getElementById('btn-refresh');
        const form = document.getElementById('generation-form');

        // åˆ‡æ¢æ ‡ç­¾
        tabForm.addEventListener('click', () => {
            tabForm.classList.add('border-b-2', 'border-blue-500', 'font-medium');
            tabTasks.classList.remove('border-b-2', 'border-blue-500', 'font-medium');
            formPanel.classList.remove('hidden');
            tasksPanel.classList.add('hidden');
        });

        tabTasks.addEventListener('click', () => {
            tabTasks.classList.add('border-b-2', 'border-blue-500', 'font-medium');
            tabForm.classList.remove('border-b-2', 'border-blue-500', 'font-medium');
            tasksPanel.classList.remove('hidden');
            formPanel.classList.add('hidden');
            fetchTasks();
        });

        // åˆ‡æ¢ä»»åŠ¡ç±»å‹
        btnT2V.addEventListener('click', () => {
            taskType.current = 't2v';
            btnT2V.classList.add('bg-blue-500', 'text-white');
            btnT2V.classList.remove('bg-gray-200', 'text-gray-700');
            btnI2V.classList.add('bg-gray-200', 'text-gray-700');
            btnI2V.classList.remove('bg-blue-500', 'text-white');
            imageUploadContainer.classList.add('hidden');
        });

        btnI2V.addEventListener('click', () => {
            taskType.current = 'i2v';
            btnI2V.classList.add('bg-blue-500', 'text-white');
            btnI2V.classList.remove('bg-gray-200', 'text-gray-700');
            btnT2V.classList.add('bg-gray-200', 'text-gray-700');
            btnT2V.classList.remove('bg-blue-500', 'text-white');
            imageUploadContainer.classList.remove('hidden');
        });

        // å›¾ç‰‡ä¸Šä¼ 
        btnUpload.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreviewContainer.innerHTML = `<img src="${e.target.result}" class="max-h-40 mx-auto" />`;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // é«˜çº§å‚æ•°
        toggleAdvanced.addEventListener('click', () => {
            advancedParams.classList.toggle('hidden');
            toggleAdvanced.textContent = advancedParams.classList.contains('hidden') ? 'æ˜¾ç¤ºé«˜çº§å‚æ•°' : 'éšè—é«˜çº§å‚æ•°';
        });

        // éšæœºç§å­
        btnRandomSeed.addEventListener('click', () => {
            document.getElementById('seed').value = Math.floor(Math.random() * 1000000);
        });

        // æäº¤è¡¨å•
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const prompt = document.getElementById('prompt').value;
            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }

            if (taskType.current === 'i2v' && !imageUpload.files.length) {
                alert('è¯·ä¸Šä¼ å›¾ç‰‡');
                return;
            }

            btnSubmit.disabled = true;
            btnSubmit.innerHTML = '<span class="inline-block animate-spin mr-2">âŸ³</span> æäº¤ä¸­...';

            const formData = new FormData();
            formData.append('task_type', taskType.current);
            formData.append('prompt', prompt);
            formData.append('negative_prompt', document.getElementById('negative-prompt').value);
            formData.append('resolution', document.getElementById('resolution').value);
            formData.append('num_frames', document.getElementById('num-frames').value);
            formData.append('fps', document.getElementById('fps').value);
            formData.append('num_inference_steps', document.getElementById('steps').value);
            formData.append('fp8', document.getElementById('fp8').checked);
            formData.append('save_vram', document.getElementById('save-vram').checked);

            const seed = document.getElementById('seed').value;
            if (seed) {
                formData.append('seed', seed);
            }

            formData.append('guidance_scale', document.getElementById('guidance-scale').value);
            formData.append('sample_shift', document.getElementById('sample-shift').value);

            if (taskType.current === 'i2v' && imageUpload.files.length) {
                formData.append('image', imageUpload.files[0]);
            }

            log(`æäº¤ä»»åŠ¡: ${API_URL}/api/generate`);

            try {
                const response = await fetch(`${API_URL}/api/generate`, {
                    method: 'POST',
                    body: formData
                });

                log(`APIå“åº”: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    let errorText = '';
                    try {
                        const error = await response.json();
                        errorText = error.detail || '';
                    } catch(e) {
                        errorText = await response.text() || '';
                    }
                    throw new Error(`${response.status} ${response.statusText} ${errorText}`);
                }

                const data = await response.json();
                log(`ä»»åŠ¡æäº¤æˆåŠŸ: ${JSON.stringify(data)}`);

                alert('ä»»åŠ¡å·²æäº¤ï¼ŒID: ' + data.task_id);

                // æ¸…ç©ºè¡¨å•
                if (taskType.current === 'i2v') {
                    imageUpload.value = '';
                    imagePreviewContainer.classList.add('hidden');
                    imagePreviewContainer.innerHTML = '';
                }

                // åˆ‡æ¢åˆ°ä»»åŠ¡åˆ—è¡¨
                tabTasks.click();

            } catch (error) {
                log(`é”™è¯¯: ${error.message}`);
                alert('é”™è¯¯: ' + error.message);
            } finally {
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'å¼€å§‹ç”Ÿæˆ';
            }
        });

        // è·å–ä»»åŠ¡åˆ—è¡¨
        async function fetchTasks() {
            const tasksContainer = document.getElementById('tasks-container');
            tasksContainer.innerHTML = '<p class="text-center py-8 text-gray-500">åŠ è½½ä¸­...</p>';

            log(`è·å–ä»»åŠ¡åˆ—è¡¨: ${API_URL}/api/tasks`);

            try {
                const response = await fetch(`${API_URL}/api/tasks`);
                log(`ä»»åŠ¡åˆ—è¡¨å“åº”: ${response.status} ${response.statusText}`);

                if (!response.ok) {
                    throw new Error(`${response.status} ${response.statusText}`);
                }

                const tasks = await response.json();
                log(`è·å–åˆ° ${tasks.length} ä¸ªä»»åŠ¡`);

                if (tasks.length === 0) {
                    tasksContainer.innerHTML = '<p class="text-center py-8 text-gray-500">æš‚æ— ä»»åŠ¡</p>';
                    return;
                }

                tasksContainer.innerHTML = '';

                tasks.forEach(task => {
                    const statusClass = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'processing': 'bg-blue-100 text-blue-800',
                        'completed': 'bg-green-100 text-green-800',
                        'failed': 'bg-red-100 text-red-800',
                        'cancelled': 'bg-gray-100 text-gray-800'
                    }[task.status] || 'bg-gray-100 text-gray-800';

                    const statusText = {
                        'pending': 'ç­‰å¾…ä¸­',
                        'processing': 'å¤„ç†ä¸­',
                        'completed': 'å·²å®Œæˆ',
                        'failed': 'å¤±è´¥',
                        'cancelled': 'å·²å–æ¶ˆ'
                    }[task.status] || task.status;

                    const taskTypeText = task.task_type === 't2v' ? 'æ–‡æœ¬ç”Ÿæˆè§†é¢‘' : 'å›¾åƒç”Ÿæˆè§†é¢‘';

                    let progressHtml = '';
                    if (task.status === 'processing') {
                        const percentage = Math.round((task.progress || 0) * 100);
                        progressHtml = `
                <div class="mb-2">
                  <div class="flex justify-between text-xs text-gray-600 mb-1">
                    <span>${task.message || 'å¤„ç†ä¸­...'}</span>
                    <span>${percentage}%</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-bar-value" style="width: ${percentage}%"></div>
                  </div>
                </div>
              `;
                    }

                    let actionButtons = '';
                    if (['pending', 'processing'].includes(task.status)) {
                        actionButtons = `<button class="text-red-500 text-sm btn-cancel" data-id="${task.task_id}">å–æ¶ˆ</button>`;
                    } else if (task.status === 'completed' && task.output_path) {
                        const videoUrl = task.output_path.startsWith('http') ? task.output_path : `${API_URL}${task.output_path}`;
                        actionButtons = `
                <button class="text-blue-500 text-sm btn-preview mr-2" data-url="${videoUrl}">é¢„è§ˆ</button>
                <a href="${videoUrl}" target="_blank" class="text-green-500 text-sm">ä¸‹è½½</a>
              `;
                    }

                    const taskEl = document.createElement('div');
                    taskEl.className = 'border rounded p-4 mb-4';
                    taskEl.innerHTML = `
              <div class="flex justify-between mb-2">
                <span class="font-medium">${taskTypeText}</span>
                <span class="px-2 py-1 rounded text-xs ${statusClass}">${statusText}</span>
              </div>
              <p class="text-sm text-gray-600 mb-2 truncate">${task.prompt}</p>
              ${progressHtml}
              <div class="flex justify-between items-center">
                <div class="text-xs text-gray-500">
                  åˆ†è¾¨ç‡: ${task.resolution} | å¸§æ•°: ${task.num_frames}
                </div>
                <div>${actionButtons}</div>
              </div>
            `;

                    tasksContainer.appendChild(taskEl);
                });

                // ç»‘å®šå–æ¶ˆæŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.btn-cancel').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const taskId = btn.getAttribute('data-id');
                        if (confirm('ç¡®å®šè¦å–æ¶ˆæ­¤ä»»åŠ¡å—ï¼Ÿ')) {
                            log(`å–æ¶ˆä»»åŠ¡: ${taskId}`);
                            try {
                                const response = await fetch(`${API_URL}/api/tasks/${taskId}/cancel`, {
                                    method: 'POST'
                                });

                                log(`å–æ¶ˆä»»åŠ¡å“åº”: ${response.status} ${response.statusText}`);

                                if (response.ok) {
                                    alert('ä»»åŠ¡å·²å–æ¶ˆ');
                                    fetchTasks();
                                } else {
                                    alert('å–æ¶ˆä»»åŠ¡å¤±è´¥');
                                }
                            } catch (error) {
                                log(`å–æ¶ˆä»»åŠ¡é”™è¯¯: ${error.message}`);
                                alert('é”™è¯¯: ' + error.message);
                            }
                        }
                    });
                });

                // ç»‘å®šé¢„è§ˆæŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.btn-preview').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const videoUrl = btn.getAttribute('data-url');
                        log(`é¢„è§ˆè§†é¢‘: ${videoUrl}`);

                        const previewEl = document.getElementById('video-preview');
                        const videoEl = document.getElementById('preview-video');

                        videoEl.src = videoUrl;
                        previewEl.classList.remove('hidden');

                        // åŠ è½½é”™è¯¯å¤„ç†
                        videoEl.onerror = () => {
                            log(`è§†é¢‘åŠ è½½å¤±è´¥: ${videoUrl}`);
                            alert('è§†é¢‘åŠ è½½å¤±è´¥ï¼Œå¯èƒ½è¿˜æœªç”Ÿæˆå®Œæˆæˆ–åœ°å€é”™è¯¯');
                        };
                    });
                });

            } catch (error) {
                log(`è·å–ä»»åŠ¡åˆ—è¡¨é”™è¯¯: ${error.message}`);
                tasksContainer.innerHTML = `<p class="text-center py-8 text-red-500">åŠ è½½å¤±è´¥: ${error.message}</p>`;
            }
        }

        // å…³é—­é¢„è§ˆ
        document.getElementById('close-preview').addEventListener('click', () => {
            const previewEl = document.getElementById('video-preview');
            const videoEl = document.getElementById('preview-video');

            videoEl.pause();
            videoEl.src = '';
            previewEl.classList.add('hidden');
        });

        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
        btnRefresh.addEventListener('click', fetchTasks);

        // åˆå§‹åŠ è½½
        log('åˆå§‹åŠ è½½ä»»åŠ¡');
        fetchTasks();
    });
</script>
</body>
</html>